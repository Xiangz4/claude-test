---
number: 2
title: 实现换汇交易核心流程
status: open
created: 2025-11-11T15:29:47Z
updated: 2025-11-11T16:07:01Z
parallel: false
depends_on: [9, 8]
conflicts_with: []
---

# Task 2: 实现换汇交易核心流程

## Description

实现完整的Saga分布式事务流程，包括订单创建、资金冻结、通道询价、换汇执行、资金出款、收益记录、异常补偿

## Acceptance Criteria

- [ ] 订单创建API实现，支持报价锁定校验和余额校验
- [ ] 资金冻结逻辑实现（基本户→在途户）
- [ ] 事件驱动流程实现（OrderCreated→FxInquiry→FxExecution→Settlement→Completed）
- [ ] 通道询价和汇率校验逻辑实现
- [ ] 通道换汇执行逻辑实现
- [ ] 资金出款和收益记录逻辑实现
- [ ] 异常补偿机制实现（解冻资金、关闭订单、触发工单）
- [ ] 订单状态机正确流转
- [ ] 所有步骤实现幂等性

## Technical Details

- 使用RabbitMQ实现事件总线
- 订单状态定义11种状态（quote_locked→order_completed）
- 使用数据库事务保证资金操作原子性
- 补偿逻辑：catch错误后调用compensateOrder函数
- 发送通知到商户（邮件/站内信）

## Estimated Effort

XL - 5-7天

## Dependencies

This task depends on:
- Task 9: 实现汇率引擎
- Task 8: 实现通道服务和资金调拨

This task cannot run in parallel with its dependencies.
